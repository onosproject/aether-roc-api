// SPDX-FileCopyrightText: 2020-present Open Networking Foundation <info@opennetworking.org>
//
// SPDX-License-Identifier: Apache-2.0

import 	(
    "github.com/onosproject/aether-roc-api/pkg/utils"
   	"github.com/onosproject/aether-roc-api/pkg/utils"
    liberrors "github.com/onosproject/onos-lib-go/pkg/errors"
   	"github.com/openconfig/gnmi/proto/gnmi"
   	"regexp"
   	"reflect"
)
var re *regexp.Regexp = regexp.MustCompile(`[A-Z][^A-Z]*`)

{{range .Types}}{{$elevenchars := .TypeName}}{{$ltn := len .TypeName}}{{if lt 11 $ltn}}{{$elevenchars = slice .TypeName 0 11}}{{end}}
{{if printf "RequestBody" | eq $elevenchars}}//Ignoring {{.TypeName}}
{{else if printf "AdditionalP" | eq $elevenchars}}//Ignoring {{.TypeName}}
{{else if eq $elevenchars "Target"}}//Ignoring Target
{{else}}
// {{printf "EncodeToGnmi%s" .TypeName}} converts OAPI to gNMI.{{$tn := .TypeName}}
func {{printf "EncodeToGnmi%s" .TypeName}}(
    jsonObj *types.{{camelCase .JsonName}}, needKey bool, removeIndex bool, target types.Target, parentPath string, params ...string) (
    []*gnmi.Update, error) {

	unchangedAttrs, tgt := utils.CheckForAdditionalProps(jsonObj)
	if tgt != nil {
		target = types.Target(*tgt)
	}
	_ = len(unchangedAttrs)

	updates := make([]*gnmi.Update, 0)
    mp := externalRef0.Device{}
    // For when the encode is called on the top level object
    if len(params) == 1 && strings.HasSuffix(parentPath, params[0]) {
        parentPath = strings.Replace(parentPath, params[0], fmt.Sprintf("{%s}", params[0]), 1)
    }

	{{range .Schema.Properties}}{{$twoChars := slice .Schema.GoType 0 2}}
    // Property: {{.JsonFieldName}} {{.Schema.GoType}}{{$isArray := eq "[]" $twoChars}}{{$objType := slice .Schema.GoType 2}}{{$isString := eq "string" .Schema.GoType}}{{$isBool := eq "bool" .Schema.GoType}}{{$isInt := eq "int" .Schema.GoType}}{{$isInt32 := eq "int32" .Schema.GoType}}{{$isInt64 := eq "int64" .Schema.GoType}}
    {{if not .Required}}if jsonObj.{{camelCase .JsonFieldName}} != nil { // Optional leaf{{else}}_, unchanged{{camelCase .JsonFieldName}} := unchangedAttrs["{{.JsonFieldName}}"]
    if !unchanged{{camelCase .JsonFieldName}} { // Mandatory leaf{{end}}
	    {{if len .Schema.EnumValues | lt 0}}
            params{{camelCase .JsonFieldName}} := make([]string, len(params))
            copy(params{{camelCase .JsonFieldName}}, params)
            params{{camelCase .JsonFieldName}} = append(params{{camelCase .JsonFieldName}}, *jsonObj.{{camelCase .JsonFieldName}})
            mpField, err := utils.CreateModelPluginObject(&mp, "{{$tn}}{{ucFirst .JsonFieldName}}", params{{camelCase .JsonFieldName}}...)
            if err != nil {
                return nil, err
            }
            update, err := utils.UpdateForElement(mpField,
            fmt.Sprintf("%s%s", parentPath, "/{{lower .JsonFieldName}}"), params{{camelCase .JsonFieldName}}...)
            if err != nil {
                return nil, err
            }
            if target != "" {
                update.Path.Target = string(target)
            }
            updates = append(updates, update)
        {{else if $isString | or $isBool | or $isInt | or $isInt32 | or $isInt64}}
        params{{camelCase .JsonFieldName}} := make([]string, len(params))
        copy(params{{camelCase .JsonFieldName}}, params)
        stringVal{{camelCase .JsonFieldName}} := fmt.Sprintf("%v", {{if not .Required}}*{{end}}jsonObj.{{camelCase .JsonFieldName}})
        {{if .Required | and $isString}}if stringVal{{camelCase .JsonFieldName}} == "" {
            return nil, liberrors.NewInvalid("mandatory field '{{.JsonFieldName}}' of '{{$tn}}' must be provided or added to 'unchanged'")
        }{{end}}
        params{{camelCase .JsonFieldName}} = append(params{{camelCase .JsonFieldName}}, stringVal{{camelCase .JsonFieldName}})
        mpField, err := utils.CreateModelPluginObject(&mp, "{{$tn}}{{camelCase .JsonFieldName}}", params{{camelCase .JsonFieldName}}...)
        if err != nil {
            return nil, err
        }
        update, err := utils.UpdateForElement(mpField, fmt.Sprintf("%s%s", parentPath, "/{{lower .JsonFieldName}}"), params{{camelCase .JsonFieldName}}...)
        if err != nil {
            return nil, err
        }
        if target != "" {
            update.Path.Target = string(target)
        }
        updates = append(updates, update)
        {{else if printf "[]string" | eq .Schema.GoType}}{{$jfn := camelCase .JsonFieldName}}
        params{{$jfn}} := make([]string, len(params))
        copy(params{{$jfn}}, params)
        params{{$jfn}} = append(params{{$jfn}}, *jsonObj.{{camelCase .JsonFieldName}}...)
        mpField, err := utils.CreateModelPluginObject(&mp, "{{$tn}}{{slice $jfn 8| ucFirst}}", params{{$jfn}}...)
        if err != nil {
            return nil, err
        }
        update, err := utils.UpdateForElement(mpField, fmt.Sprintf("%s%s", parentPath, "/{{slice $jfn 8| lower}}"), params{{$jfn}}...)
        if err != nil {
            return nil, err
        }
        if target != "" {
            update.Path.Target = string(target)
        }
        updates = append(updates, update)
        {{else if eq $isArray false}}{{$suffix := .JsonFieldName }}
	    update, err := EncodeToGnmi{{.Schema.GoType}}(
	        jsonObj.{{camelCase .JsonFieldName | title}}, false, removeIndex, target,
	        fmt.Sprintf("%s/%s", parentPath, "{{lower $suffix}}"), params...)
        if err != nil {
            return nil, err
        }
        updates = append(updates, update...){{end}}{{if .Required}}
    {{end}}
	}{{end}}
	{{range .Schema.Properties}}{{$twoChars := slice .Schema.GoType 0 2}}{{$isArray := eq "[]" $twoChars}}{{$objType := slice .Schema.GoType 2}}
	    {{if ne $objType "string" | and $isArray}}
        // Property: {{.JsonFieldName}} {{.Schema.GoType}}
        if jsonObj.{{camelCase .JsonFieldName | title}} != nil {
            for _, item := range *jsonObj.{{camelCase .JsonFieldName | title}} {
                item := item //Pinning
                params{{camelCase .JsonFieldName}} := make([]string, len(params))
                copy(params{{camelCase .JsonFieldName}}, params)
                params{{camelCase .JsonFieldName}} = append(params{{camelCase .JsonFieldName}}, "unknown_id")
                updates{{camelCase .JsonFieldName}}, err :=
                    EncodeToGnmi{{$objType}}(&item, true, removeIndex, target,
                    fmt.Sprintf("%s/%s/{unknown_key}", parentPath, "{{lower .JsonFieldName}}"), params{{camelCase .JsonFieldName}}...)
                if err != nil {
                     return nil, err
                }
                updates = append(updates, updates{{camelCase .JsonFieldName}}...)
            }
        }
        {{end}}
    {{end}}
    if needKey || removeIndex {
        reflectKey, err := utils.FindModelPluginObject(mp, "{{$tn}}", params...)
        if err != nil {
            return nil, err
        }
        if reflectKey == nil {
            return updates, nil
        }
        reflectType := reflectKey.Type()
        reflect2 := reflect.New(reflectType) // Needed so the type can be read to extract list
        reflect2.Elem().Set(*reflectKey)
        keyMap, err := utils.ExtractGnmiListKeyMap(reflect2.Interface())
        if err != nil {
            return nil, err
        }
        indices := make([]int, 0)
        for k, v := range keyMap {
            // parentPath = fmt.Sprintf("%s/{%s}", parentPath, k)
            for i, u := range updates {
                if needKey {
                    if err := utils.ReplaceUnknownKey(u, k, v, utils.UnknownKey, utils.UnknownID); err != nil {
                        return nil, err
                    }
                }
                if removeIndex {
                    lastElem := u.Path.Elem[len(u.Path.Elem) - 1]
                    if k == lastElem.Name {
                        indices = append(indices, i)
                    }
                }
            }
        }
        // Only remove the index field if it's not the only field
        if removeIndex && len(indices) > 0  && len(updates) > 1 {
            updates = utils.RemoveIndexAttributes(updates, indices)
        }
    }
	return updates, nil
}

{{end}}
{{end}}

